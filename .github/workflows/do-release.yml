name: Create a release

permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGED=$(git diff --name-only $LAST_TAG..HEAD | wc -l)
          if [ "$CHANGED" -eq "0" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

  build-generals:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed == 'true'
    name: Build Generals${{ matrix.preset && '' }}
    strategy:
      matrix:
        include:
          - preset: "vc6"
            tools: true
            extras: true
          - preset: "win32-vcpkg"
            tools: true
            extras: true
      fail-fast: false
    uses: ./.github/workflows/build-toolchain.yml
    with:
      game: "Generals"
      preset: ${{ matrix.preset }}
      tools: ${{ matrix.tools }}
      extras: ${{ matrix.extras }}
    secrets: inherit

  build-generalsmd:
    name: Build GeneralsMD${{ matrix.preset && '' }}
    strategy:
      matrix:
        include:
          - preset: "vc6"
            tools: true
            extras: true
          - preset: "win32"
            tools: true
            extras: true
      fail-fast: false
    uses: ./.github/workflows/build-toolchain.yml
    with:
      game: "GeneralsMD"
      preset: ${{ matrix.preset }}
      tools: ${{ matrix.tools }}
      extras: ${{ matrix.extras }}
    secrets: inherit

  create-release:
    name: Create Release
    needs: [ build-generals, build-generalsmd ]
    runs-on: ubuntu-latest
    steps:
      - name: Set Date Output
        id: set_date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # Generals vc6
      - name: Download Generals VC6 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Generals-vc6+t+e
          path: generals-vc6-artifacts

      - name: Prepare and Zip Generals VC6
        run: |
          mkdir generals-vc6-release
          cp generals-vc6-artifacts/generalsv.exe generals-vc6-release/GeneralsV.exe
          cp generals-vc6-artifacts/W3DViewV.exe generals-vc6-release/W3DViewV.exe
          cp generals-vc6-artifacts/WorldBuilderV.exe generals-vc6-release/WorldBuilderV.exe
          zip -j generals-vc6-${{ steps.set_date.outputs.date }}-alpha.zip generals-vc6-release/*

      # Generals win32
      - name: Download Generals Win32 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Generals-win32-vcpkg+t+e
          path: generals-win32-artifacts

      - name: Prepare and Zip Generals Win32
        run: |
          mkdir generals-win32-release
          cp generals-win32-artifacts/generalsv.exe generals-win32-release/GeneralsV.exe
          cp generals-win32-artifacts/W3DViewV.exe generals-win32-release/W3DViewV.exe
          cp generals-win32-artifacts/WorldBuilderV.exe generals-win32-release/WorldBuilderV.exe
          zip -j generals-win32-${{ steps.set_date.outputs.date }}-alpha.zip generals-win32-release/*

      # GeneralsMD vc6
      - name: Download GeneralsMD VC6 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: GeneralsMD-vc6+t+e
          path: generalsmd-vc6-artifacts

      - name: Prepare and Zip GeneralsMD VC6
        run: |
          mkdir generalsmd-vc6-release
          cp generalsmd-vc6-artifacts/generalszh.exe generalsmd-vc6-release/GeneralsZHv.exe
          cp generalsmd-vc6-artifacts/W3DViewZH.exe generalsmd-vc6-release/W3DViewZHv.exe
          cp generalsmd-vc6-artifacts/WorldBuilderZH.exe generalsmd-vc6-release/WorldBuilderZHv.exe
          zip -j generalszh-vc6-${{ steps.set_date.outputs.date }}-alpha.zip generalsmd-vc6-release/*

      # GeneralsMD win32
      - name: Download GeneralsMD Win32 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: GeneralsMD-win32+t+e
          path: generalsmd-win32-artifacts

      - name: Prepare and Zip GeneralsMD Win32
        run: |
          mkdir generalsmd-win32-release
          cp generalsmd-win32-artifacts/generalszh.exe generalsmd-win32-release/GeneralsZHv.exe
          cp generalsmd-win32-artifacts/W3DViewZH.exe generalsmd-win32-release/W3DViewZHv.exe
          cp generalsmd-win32-artifacts/WorldBuilderZH.exe generalsmd-win32-release/WorldBuilderZHv.exe
          zip -j generalszh-win32-${{ steps.set_date.outputs.date }}-alpha.zip generalsmd-win32-release/*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_date.outputs.date }}-alpha
          name: ${{ steps.set_date.outputs.date }}-alpha
          body: |
            **Build notes:**
            
            - **VC6 builds**: May be less compatible with modern systems, but guarantee compatibility with the original binary for multiplayer.
            - **Win32 builds**: Offer better compatibility with modern systems, but multiplayer will only work with other win32 builds.
          files: |
            generals-*-*-alpha.zip
            generalszh-*-*-alpha.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}